<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    文件系统编程指导第三章 - Arisu
    
    </title>
    <link rel="shortcut icon" href="https://gitee.com/saiha/images/raw/main/Arisu/Arisu.png" type="image/png" />

    
    
    <link href="atom.xml" rel="alternate" title="Arisu" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/style.min.css">
    <link rel="stylesheet" href="asset/css/doc.css">
    <script src="asset/app.js"></script>
</head>
  <body>
    <section class="hero">
      <div class="hero-head">
          <nav class="navbar" role="navigation" aria-label="main navigation">
              <div class="container">
              <div class="navbar-brand">
                
                <a target="_self" class="navbar-item " href="index.html">主页</a>
                
                <a target="_self" class="navbar-item " href="Apple.html">Apple</a>
                

                <a role="button" id="navbarSNSRssSwitchBtn" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarSNSRssButtons">
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                </a>
              </div>
            
              <div id="navbarSNSRssButtons" class="navbar-menu">
                <div class="navbar-start">
                  
                </div>
            
                <div class="navbar-end">
                  <div class="navbar-item">
                    <!--buttons start-->
                    <div class="buttons">
                      
                        
                        
                        
                        
                      
                      <a href="atom.xml" target="_blank" title="RSS">
                          <span class="icon is-large has-text-black-bis">
                              <svg class="svg-inline--fa fa-rss fa-w-14 fa-lg" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                          </span>
                      </a>
                    </div>
                    <!--buttons end-->

                  </div>
                </div>
                </div>
              </div>
            </nav>
      </div>

 <div class="hero-body ct-body"></div>
      
    </section>
    <section class="ct-body">
      <div class="container">
          <div class="columns is-variable bd-klmn-columns is-4 is-centered">
              <div class="column is-four-fifths">
                  <div class="post-body single-content">
                    
                    <h1 class="title">
                            文件系统编程指导第三章   
                      </h1>
                     
                    
                      <div class="media">
                            
                            <figure class="media-left">
                              <p class="image is-48x48">
                                
                                  <img class="is-rounded" src="https://gitee.com/saiha/images/raw/main/Arisu/Arisu.png">
                                
                              </p>
                            </figure>
                            
                            <div class="media-content">
                              <div class="content">
                                <p>
                                 <span class="date">2020/05/25</span>
                                  <span class="tran-posted-in">posted in</span>&nbsp; 
                                  
                                      <span class="posted-in"><a href='%E9%9A%8F%E7%AC%94.html'>随笔</a></span>
                                         
                                  

                                   
                                      
                                  <br />
                                  <span class="tran-tags">Tags:</span>&nbsp;
                                  
                                    <a class="tag is-link is-light" href='tag_%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3.html'>#技术文档</a>
                                     

                                </p>
                              </div>
                            </div>
                         
                    </div>
                </div>
                  <article class="markdown-body single-content">
                    <h1><a id="%E6%96%87%E4%BB%B6%E5%8D%8F%E8%B0%83%E8%80%85%E5%92%8C%E6%BC%94%E7%A4%BA%E8%80%85%E7%9A%84%E8%A7%92%E8%89%B2" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>文件协调者和演示者的角色</h1>
<p>因为文件系统由所有正在运行的进程共享，所以当两个进程（或同一进程中的两个线程）试图同时作用于同一文件时，可能会出现问题。作用在同一文件上的两个不同进程可能会进行另一个进程不期望的更改，这可能导致更严重的问题，例如崩溃或数据损坏。即使在一个程序中，同时作用于该文件的两个线程也可能破坏该文件并使其无法使用。为避免这种类型的文件争用，macOS 10.7 及更高版本包括对文件协调器的支持，这使您可以在不同进程或不同线程之间安全地协调文件访问。</p>
<p>文件协调者的工作是，每当他们关心的文件被另一个进程或线程执行操作时，便通知相关方。在这种情况下，感兴趣的各方是您应用程序的对象。应用程序的任何对象都可以将自己指定为文件演示者，即，一个直接与文件一起使用的对象，当其他对象对该文件启动操作时需要通知该对象。应用程序中的任何对象都可以是文件演示者，文件演示者可以监视单个文件或文件的整个目录。例如，使用图像的应用程序将指定一个或多个对象作为相应图像文件的文件演示者。如果用户在应用程序运行时从 Finder 中删除了图像文件，则将通知该图像文件的文件演示者，并为其提供删除文件的机会。</p>
<h2><a id="%E4%BD%BF%E7%94%A8nsdocument%E5%92%8C-uidocument%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E5%8D%8F%E8%B0%83%E5%99%A8%E5%92%8C%E6%BC%94%E7%A4%BA%E8%80%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用 NSDocument 和 UIDocument 处理文件协调器和演示者</h2>
<p>iOS 中的 <code>UIDocument</code> 类和 macOS 中的 <code>NSDocument</code> 类封装了用户文档的数据。这些类自动支持：</p>
<ul>
<li><code>NSFileCoordinator</code> 实现</li>
<li><code>NSFilePresenter</code> 实现</li>
<li>自动保存实现</li>
</ul>
<p>只要有可能，探索使用这些类来存储您的用户数据。处理用户数据文件以外的文件时，您的应用仅需要与文件协调器和文件演示者直接协同工作。</p>
<p>使用文档类的应用程序在 <code>Application Support</code>，<code>Cache</code> 或临时目录（<code>temporary</code>）中读写私有文件时，无需使用文件协调器。这些文件被视为私有文件。</p>
<h2><a id="%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%8D%8F%E8%B0%83%E5%99%A8%E7%A1%AE%E4%BF%9D%E5%AE%89%E5%85%A8%E7%9A%84%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用文件协调器确保安全的读写操作</h2>
<p>当您的应用程序想要修改文件时，它会创建一个文件协调器对象，以将其意图通知任何感兴趣的文件演示者。文件协调者会与所有相关文件演示者就您的应用对文件的意图进行交流。文件演示者全部响应后，文件协调器将执行一个包含您要执行的实际操作的块。所有这些都是异步发生的，因此您的应用程序线程不必显式等待。</p>
<p>将对文件协调器的支持添加到代码中的步骤如下：</p>
<ol>
<li>对于管理文件或目录的每个对象，使相应的类采用 <code>NSFilePresenter</code> 协议。当受监视文件发生更改时，系统使用此协议的方法来通知您的对象。</li>
<li>在运行时初始化文件演示者对象时，请通过调用 <code>NSFileCoordinator</code> 的 <code>addFilePresenter:</code> 类方法立即注册它。</li>
<li>当您的文件演示者对象在文件或目录上执行其自己的操作时，请创建一个 <code>NSFileCoordinator</code> 对象，然后调用与您计划执行的操作相对应的方法。</li>
<li>在释放文件演示者对象之前，请调用 <code>NSFileCoordinator</code> 的 <code>removeFilePresenter:class</code> 方法将其注销为文件演示者。由于 <code>NSFileCoordinator</code> 会保留您的文件演示者对象，因此在您取消注册之前，系统不会取消分配它。</li>
</ol>
<h3><a id="%E9%80%89%E6%8B%A9%E8%A6%81%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E6%BC%94%E7%A4%BA%E5%99%A8%E7%9B%91%E8%A7%86%E7%9A%84%E6%96%87%E4%BB%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>选择要使用文件演示器监视的文件</h3>
<p>并非您的应用程序触及的每个文件都需要监视。应用程序在监视以下类型的项目时使用文件演示器：</p>
<ul>
<li>用户文档</li>
<li>应用程序管理的包含媒体文件（音乐，照片，电影等）的目录</li>
<li>位于远程服务器上的文件</li>
</ul>
<p>通常，您不需要监视应用程序捆绑包中的文件或应用程序专用的并存储在 <code>〜/Library</code> 目录的应用程序特定子目录中的任何文件。如果您的应用程序在沙箱中运行，那么您也不需要监视在沙箱目录中创建的任何文件。</p>
<h3><a id="%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E6%BC%94%E7%A4%BA%E8%80%85%E5%AF%B9%E8%B1%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>实现文件演示者对象</h3>
<p>应用程序的大多数文件演示者对象将是控制器对象或数据模型对象。控制器对象是自然选择，因为它们通常会协调其他对象（包括数据模型对象）的创建和修改。但是，如果您的应用程序监视成百上千个文件，则可能需要将对管理单个文件的支持转移到数据模型对象中。</p>
<p>要实现文件演示者对象，请使该对象的类符合 <code>NSFilePresenter</code> 协议。该协议中的方法指示可以在文件或目录上执行的操作的类型。您对各种方法的实现是对象响应并采取任何必要措施的地方。您不必实现协议的每个方法，但可以实现所有可能影响对象与文件或目录交互方式的方法。您使用协议的属性和方法来执行以下操作：</p>
<ul>
<li>提供要监视的文件或目录的URL。（所有文件演示者都通过实现必需的 <code>presentedItemURL</code> 属性来执行此操作。）</li>
<li>暂时放弃对文件或目录的控制，以便另一个对象可以对其进行写入或读取。</li>
<li>在另一个对象尝试从文件读取之前，请保存所有未保存的更改。</li>
<li>跟踪对文件或目录的内容或属性的更改。</li>
<li>当文件或目录被移动或删除时，更新您的数据结构。</li>
<li>提供一个调度队列，在该队列上执行文件演示者方法。</li>
</ul>
<p>如果要实现基于文档的应用程序，则无需将文件演示者语义合并到 <code>NSDocument</code> 子类中。<code>NSDocument</code> 类已经符合 <code>NSFilePresenter</code> 协议并实现了适当的方法。因此，您的所有文档都会自动将自己注册为相应文件的演示者，并执行诸如保存更改和跟踪文档更改的操作。</p>
<p>您的所有文件演示者方法都应该轻量级并且可以快速执行。如果您的文件演示者正在响应更改（例如，在 <code>presentedItemDidChange</code>，<code>presentedItemDidMoveToURL:</code> 或 <code>accommitmentPresentedItemDeletionWithCompletionHandler:</code> 方法中），则可能要避免直接从文件演示者方法中合并更改。取而代之的是，异步地将块分配到分配队列，并在以后处理更改。这样一来，您便可以方便地在应用程序中处理更改，而不会引起启动更改的文件协调器不必要的延迟。当然，当保存或放弃对文件的控制（例如，在 <code>relinquishPresentedItemToReader:</code> 、<code>relinquishPresentedItemToWriter:</code> 或 <code>savePresentedItemChangesWithCompletionHandler:</code> 方法中）时，您会立即执行所有必要的操作，而不会延迟它们。</p>
<p>有关如何实现 NSFilePresenter 协议方法的详细信息，请参见 <a href="https://developer.apple.com/documentation/foundation/nsfilepresenter">NSFilePresenter 协议参考</a>。</p>
<h3><a id="%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E6%B3%A8%E5%86%8C%E6%96%87%E4%BB%B6%E6%BC%94%E7%A4%BA%E8%80%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>在系统中注册文件演示者</h3>
<p>应用创建文件演示者对象后，使用 <code>NSFileCoordinator</code> 的 <code>addFilePresenter:</code> 类方法在系统中注册它：</p>
<pre><code class="language-objective-c">MyFilePresenter *filePresenter = [[MyFilePresenter alloc] init];
[NSFileCoordinator addFilePresenter:filePresenter];
</code></pre>
<p>注册一个对象会告诉系统它对特定文件感兴趣，并希望开始接收有关对该文件的操作的通知。如上例所示，您的应用可以在文件演示者初始化后注册，也可以将其注册为文件演示者初始化方法的一部分。</p>
<p>在您的应用释放文件展示者对象之前，请使用 <code>NSFileCoordinator</code> 的 <code>removeFilePresenter:</code> 方法注销它：</p>
<pre><code class="language-objective-c">[NSFileCoordinator removeFilePresenter:filePresenter];
</code></pre>
<p>尽管可以使用其初始化方法注册文件演示器，但不要使用其释放方法注销文件演示器。由于 <code>NSFileCoordinator</code> 保留已注册的文件演示者对象，因此即使您自己的代码不再保留它，系统也不会取消分配文件演示者，直到您取消注册为止。因此，释放文件演示者对象而不先注销它是一个编程错误。</p>
<h3><a id="%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%8D%8F%E8%B0%83%E5%99%A8%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E6%9B%B4%E6%94%B9" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用文件协调器启动文件更改</h3>
<p>在您的文件展示者对象对其监视的文件进行任何更改之前，它必须创建一个 <code>NSFileCoordinator</code> 对象，并指示其将要进行的更改的类型。文件协调器是一种机制，通过该机制，系统范围内的文件演示者可以收到有关更改的通知。该对象与系统一起使用，以通知其他线程和进程，并为那些线程和进程中的文件演示者提供响应的机会。在所有感兴趣的文件提交者都做出响应之后，文件协调器将执行您提供的代码块以执行实际操作。要使用文件协调器对象，请执行以下操作：</p>
<ol>
<li>
<p>创建 <code>NSFileCoordinator</code> 类的实例。</p>
</li>
<li>
<p>调用与您要对文件或目录执行的操作相对应的实例方法：</p>
<ul>
<li>调用 <code>coordinateReadingItemAtURL:options:error:byAccessor:</code> 方法以读取文件或目录的内容。</li>
<li>调用 <code>coordinateWritingItemAtURL:options:error:byAccessor:</code> 方法以写入文件或更改目录的内容。</li>
<li>调用 <code>coordinateReadingItemAtURL:options:writingItemAtURL:options:error:byAccessor:</code> 方法以从文件或目录读取和写入。</li>
<li>调用 <code>itemAtURL:didMoveToURL:</code> 方法将文件或目录移动到新位置。</li>
</ul>
<p>调用这些方法时，将提供一个块来实际读取或写入文件或目录。如果您需要批量读取或写入多个项目，请调用 <code>prepareForReadingItemsAtURLs:options:writingItemsAtURLs:options:error:byAccessor:</code> 方法，并使用传递给该方法的块来协调各个文件的读写。使用该方法处理批处理文件比尝试单独读取或写入文件要有效得多。</p>
</li>
<li>
<p>完成后，释放文件协调器对象。</p>
</li>
</ol>
<p>有关如何使用 <code>NSFileCoordinator</code> 方法的更多信息，请参见 <a href="https://developer.apple.com/documentation/foundation/nsfilecoordinator">NSFileCoordinator 类参考</a>。</p>
<div class="row">
    <div class="large-6 columns">
	       <p class="text-left" style="padding-top:25px;">
			     <a href="http://www.plainson.top/MWeb/Grass/FSG_访问文件和目录.html">&laquo; 上一章：访问文件和目录</a>
			 </p>
    </div>
    <div class="large-6 columns">
	       <p class="text-right" style="padding-top:25px;">
			     <a href="http://www.plainson.top/MWeb/Grass/FSG_iCloud_文件管理.html">下一章：iCloud_文件管理 &raquo;</a> 
			 </p>
    </div>
</div>

                  </article>
                  <div class="comments-wrap">
                    <div class="share-comments">
                      

                      

                      
                    </div>
                  </div><!-- end comments wrap -->
              </div>
            </div><!-- end columns -->
      </div><!-- end container -->
    </section>



    <footer class="footer">
        <div class="content has-text-centered">
          <p>
              Copyright &copy; 2019
              Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
              Theme used <a target="_blank" href="https://bulma.io/">Bulma CSS</a>.
          </p>
        </div>
      </footer>



  













<script src="asset/prism.js"></script>



  
    




  </body>
</html>
